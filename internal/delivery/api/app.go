package api

import (
	"github.com/abc-valera/flugo-api/internal/delivery/handler"
	"github.com/abc-valera/flugo-api/internal/infrastructure/framework"
	"github.com/abc-valera/flugo-api/internal/infrastructure/repository"
	"github.com/abc-valera/flugo-api/internal/service"
	"github.com/gofiber/fiber/v2"
	"github.com/gofiber/fiber/v2/middleware/logger"
	"github.com/gofiber/swagger"

	_ "github.com/abc-valera/flugo-api/docs/swagger" // docs generated by Swag CLI
	_ "github.com/lib/pq"
)

//	@title			Flugo
//	@version		0.1
//	@description	API for Flugo social network

//	@contact.name	API Support
//	@contact.url	https://github.com/abc-valera
//	@contact.email	valeriy.tymofieiev@gmail.com

//	@license.name	MIT
//	@license.url	https://github.com/abc-valera

// @host						localhost:3000
// @BasePath					/
// @query.collection.format	multi
func RunAPI(PORT string, frameworks *framework.Frameworks, repos *repository.Repositories, services *service.Services) error {
	handlers := handler.NewHandlers(repos, services)

	// Custom error handler
	app := fiber.New(fiber.Config{
		ErrorHandler: errorHandler,
	})

	// docs
	app.Get("/docs/*", swagger.HandlerDefault)

	// TODO: write custom logger middleware
	// Logger middleware
	app.Use(logger.New())

	routes(app, frameworks, handlers)

	return app.Listen(PORT)
}
